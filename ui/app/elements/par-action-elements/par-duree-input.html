<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="par-duree-input">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: inline-block;
      }
      input[is="iron-input"] {
        font: inherit;
        outline: none;
        box-shadow: none;
        border: none;
        width: auto;
        text-align: right;
      }
    </style>

    <input is="iron-input" type="number" pattern="[0-9]*" bind-value="{{_jours}}" min="0" aria-label="Nombre de jours">
    jours
    <input is="iron-input" type="number" pattern="[0-9]*" bind-value="{{_heures}}" min="0" aria-label="Nombre d'heures'">
    heures
    <input is="iron-input" type="number" pattern="[0-9]*" bind-value="{{_minutes}}" min="0" aria-label="Nombre de minutes">
    minutes
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'par-duree-input',

        behaviors: [
          Polymer.IronFormElementBehavior,
          Polymer.IronValidatableBehavior
        ],

        properties: {
          value: {
            type: String,
            notify: true,
            observer: '_valueChanged'
          },

          duration: {
            type: Object,
            notify: true,
            readOnly: true,
            observer: '_durationChanged'
          },

          _jours: {
            type: Number
          },

          _heures: {
            type: Number
          },

          _minutes: {
            type: Number
          }
        },

        observers: [
          '_inputsChanged(_jours, _heures, _minutes)'
        ],

        ready: function() {
        },

        _durationChanged: function(duration) {
          this.value = duration.toISOString();
        },

        _valueChanged: function(dureeISO) {
          var duration = dureeISO ?
            moment.duration(dureeISO) :
            moment.duration();

          if (!this.duration || this.duration.asMilliseconds() !== duration.asMilliseconds()) {
            this._setDuration(duration);
            // this._jours = this.duration.days() + (30 * this.duration.months());
            this._jours = Math.floor(this.duration.asDays());
            this._heures = this.duration.hours();
            this._minutes = this.duration.minutes();
          }

        },

        _inputsChanged: function(jours, heures, minutes) {
          jours = parseInt(jours);
          heures = parseInt(heures);
          minutes = parseInt(minutes);

          jours = jours < 0 ? 0 : jours;
          heures = heures < 0 ? 0 : heures;
          minutes = minutes < 0 ? 0 : minutes;

          this._minutes = minutes % 60;
          var _totalHeures = heures + Math.floor(minutes / 60);
          this._heures = _totalHeures % 7;
          this._jours = jours + Math.floor(_totalHeures / 7);

          var duration = moment.duration({
            days: this._jours,
            hours: this._heures,
            minutes: this._minutes
          });

          if (this.duration.asMilliseconds() !== duration.asMilliseconds()) {
            this._setDuration(duration);
          }
        }

      });
    })();
  </script>

</dom-module>
