<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="par-duree-input">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: inline-block;
        width: 100%;
      }

      paper-input[type="number"] {
        --paper-input-container-input: {

          text-align: right;
        };
      }
    </style>

    <div class="content layout horizontal justified">
      <paper-input id="daysInput" label="Jours" type="number" on-change="_inputsChanged" pattern="[0-9]*" min="0" aria-label="Nombre de jours">
      </paper-input>

      <paper-input id="hoursInput" label="Heures" type="number" on-change="_inputsChanged" pattern="[0-9]*" aria-label="Nombre d'heures'">
      </paper-input>

      <paper-input id="minutesInput" label="Minutes" type="number" on-change="_inputsChanged" pattern="[0-9]*" aria-label="Nombre de minutes">
      </paper-input>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'par-duree-input',

        behaviors: [
          Polymer.IronFormElementBehavior,
          Polymer.IronValidatableBehavior
        ],

        properties: {
          value: {
            type: String,
            notify: true,
            observer: '_valueChanged'
          },

          duration: {
            type: Object,
            notify: true,
            readOnly: true,
            observer: '_durationChanged'
          }
        },

        _durationChanged: function(duration) {

          var valueDuration = moment.duration(this.value);
          if (valueDuration.asMilliseconds() !== duration.asMilliseconds()) {
            this.value = duration.toISOString();
          }

          this.$.daysInput.value = Math.floor(this.duration.asDays());
          this.$.hoursInput.value = this.duration.hours() >= 7 ? 6 : this.duration.hours();
          this.$.minutesInput.value = this.duration.minutes();

        },

        _valueChanged: function(dureeISO) {

          var duration = dureeISO ? moment.duration(dureeISO) : moment.duration();
          this._setDuration(duration);
        },

        _inputsChanged: function() {

          // On parse les nombre de jours, heures, minutes
          var jours = parseInt(this.$.daysInput.value);
          var heures = parseInt(this.$.hoursInput.value);
          var minutes = parseInt(this.$.minutesInput.value);

          if (minutes >= 60) {
            heures += Math.floor(minutes / 60);
            minutes = minutes % 60;
          } else if (minutes < 0) {
            heures += Math.floor(minutes / 60);
            minutes = 60 + (minutes % 60);
          }

          if (heures >= 7) {
            jours += Math.floor(heures / 7);
            heures = heures % 7;
          } else if (heures < 0) {
            jours += Math.floor(heures / 7);
            heures = 7 + (heures % 7);
          }

          var duration = moment.duration({
            days: jours,
            hours: heures,
            minutes: minutes
          });

          // Si la durée est négative, elle est égale à 0
          if (duration.asMilliseconds() < 0) {
            duration = moment.duration(0);
          }

          this._setDuration(duration);
        }

      });
    })();
  </script>

</dom-module>
