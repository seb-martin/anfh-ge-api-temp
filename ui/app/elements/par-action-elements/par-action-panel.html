<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="par-action-panel">
  <template>

    <style include="shared-styles"></style>

    <style>
    :host {
      display: block;
    }

    #backFab {
      position: fixed;
      z-index: 100;
      @apply(--shadow-elevation-6dp);
    }

    #createFab, #updateFab {
      margin: 5px;
      position:fixed;
      bottom: 60px;
      right: 60px;
      z-index: 4;
      @apply(--shadow-elevation-6dp);
    }

    .content {
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    paper-card {
      width: 100%;
      margin: 20px 0;
    }

    paper-material {
      padding: 0 20px;
      margin: 10px 0;
    }


    </style>

    <par-axes-data id="axesData" code-region="[[action.region]]" exercice="[[action.exercice]]" axes="{{_axes}}"></par-axes-data>

    <paper-fab id="backFab" icon="icons:arrow-back" on-tap="_backTap"></paper-fab>

    <template is="dom-if" if="{{!_dirty._id}}">
      <paper-fab id="createFab" icon="icons:add" on-tap="_createTap"></paper-fab>
      <!-- <paper-button raised on-tap="_createTap">Créer</paper-button> -->
    </template>
    <template is="dom-if" if="{{_dirty._id}}">
      <paper-fab id="updateFab" icon="icons:check" on-tap="_updateTap"></paper-fab>
      <!-- <paper-button raised on-tap="_updateTap">Modifier</paper-button> -->
    </template>


    <div class="content">

      <form is="iron-form" id="actionForm">
        <paper-card heading="{{action.intitule}}">
          <div class="card-content layout vertical">

            <div class="layout horizontal">
              <span class="flex"></span>
              <paper-toggle-button checked="{{_dirty._publie}}">Publiée</paper-toggle-button>
            </div>

            <paper-material elevation="1">
              <paper-input name="intitule" label="Intitulé" required char-counter maxlength="150" auto-validate value="{{_dirty.intitule}}"></paper-input>
            </paper-material>

            <paper-material elevation="1">
              <par-axe-select label="Axe" axes="[[_axes]]" value="{{_dirty.axe}}"></par-axe-select>
            </paper-material>

            <paper-material elevation="1">
              <par-nature-select label="Nature" value="{{_dirty.nature}}" default="R" required auto-validate></par-nature-select>
            </paper-material>

            <paper-material elevation="1">
              <par-typologie-select label="Typologie FPTLV" value="{{_dirty.typologie}}" required auto-validate></par-typologie-select>
            </paper-material>

            <paper-material elevation="1">
              <paper-input name="titulaire" label="Titulaire" required char-counter maxlength="250" auto-validate value="{{_dirty.titulaire}}"></paper-input>
            </paper-material>

            <paper-material elevation="1">
              <par-marked-textarea label="Contexte" value="{{_dirty.contexte}}" maxlength="1000"></par-marked-textarea>
            </paper-material>

            <paper-material elevation="1">
              <par-marked-textarea label="Objectifs" value="{{_dirty.objectifs}}" maxlength="600"></par-marked-textarea>
            </paper-material>

            <paper-card heading="Publics">
              <div class="card-content">
                <par-publics-list publics="{{_dirty.publics}}"></par-publics-list>
              </div>
            </paper-card>

            <br>

          </div>
        </paper-card>

        <template is="dom-repeat" items="{{_dirty.modules}}" as="module">

          <paper-card heading="{{module.intitule}}">
            <div class="card-content layout vertical">

              <paper-material elevation="1">
                <paper-input name="intitule" label="Intitulé" required char-counter maxlength="150" auto-validate value="{{module.intitule}}"></paper-input>
              </paper-material>

              <paper-material elevation="1">
                <paper-input-container always-float-label auto-validate attr-for-value="value">
                  <label>Durée</label>
                  <par-duree-input class="paper-input-input" value="{{module.duree}}"></par-duree-input>
                  <paper-input-error>Durée invalide</paper-input-error>
                </paper-input-container>

              </paper-material>

              <paper-material elevation="1">
                <paper-input label="Formateur" required char-counter maxlength="250" auto-validate value="{{module.formateur}}"></paper-input>
              </paper-material>

              <paper-material elevation="1">
                <par-marked-textarea label="Contexte" value="{{module.contexte}}" maxlength="1000"></par-marked-textarea>
              </paper-material>

              <paper-material elevation="1">
                <par-marked-textarea label="Objectifs" value="{{module.objectifs}}" maxlength="600"></par-marked-textarea>
              </paper-material>

              <paper-material elevation="1">
                <par-marked-textarea label="Programme" value="{{module.programme}}" maxlength="1700"></par-marked-textarea>
              </paper-material>

              <paper-card heading="Publics">
                <div class="card-content">
                  <par-publics-list publics="{{module.publics}}"></par-publics-list>
                </div>
              </paper-card>
            </div>
            <div class="card-actions layout horizontal">
              <span class="flex"></span>
              <paper-fab mini icon="icons:delete" on-tap="_removeModule"></paper-fab>
            </div>
          </paper-card>

        </template>

        <div class="layout horizontal">
          <span class="flex"></span>
          <paper-fab id="addModuleFab" mini icon="icons:create" title="Ajouter un nouveau module" on-tap="_addModule"></paper-fab>
        </div>

      </form>

    </div>

    <paper-toast id="toast"></paper-toast>

  </template>


  <script>
  (function() {
    'use strict';

    var cloneAction = function(action) {
      if (!action) {
        return action;
      }

      var clone = {
        _id: action._id,
        _publie: action._publie,
        region: action.region,
        exercice: action.exercice,
        axe: action.axe,
        intitule: action.intitule,
        contexte: action.contexte,
        objectifs: action.objectifs,
        typologie: action.typologie,
        titulaire: action.titulaire,
        publics: [],
        modules: [],
        calendrier: []
      };

      if (Array.isArray(action.publics)) {
        action.publics.forEach(function(p) {
          clone.publics.push(p);
        });
      }

      if (Array.isArray(action.modules)) {
        action.modules.forEach(function(m) {
          var moduleClone = {
            intitule: m.intitule,
            contexte: m.contexte,
            objectifs: m.objectifs,
            programme: m.programme,
            duree: m.duree,
            formateur: m.formateur,
            publics: []
          };

          if (Array.isArray(m.publics)) {
            m.publics.forEach(function(p) {
              moduleClone.publics.push(p);
            });
          }

          clone.modules.push(moduleClone);
        });
      }

      return clone;
    };

    Polymer({
      is: 'par-action-panel',

      properties: {
        action: {
          type: Object,
          notify: true,
          observer: '_actionChanged'
        }
      },

      _actionChanged: function(action) {
        this._dirty = cloneAction(action);
      },

      _backTap: function() {
        this._dirty = null;
        this.fire('back');
      },

      _cancelTap: function() {
        this._dirty = null;
        this.fire('cancel');
      },

      _createTap: function() {
        if (this.$.actionForm.validate()) {
          this.action = this._dirty;
          this.fire('create', {action: this.action});
        } else {
          this.$.toast.text = 'Création l\'action refusée.';
          this.$.toast.text += ' Le formulaire comporte des données invalides';
          this.$.toast.open();
        }
      },

      _updateTap: function() {
        if (this.$.actionForm.validate()) {
          this.action = this._dirty;
          this.fire('update', {action: this.action});
        } else {
          this.$.toast.text = 'Modification de l\'action refusée.';
          this.$.toast.text += ' Le formulaire comporte des données invalides';
          this.$.toast.open();
        }
      },

      _addModule: function() {
        if (!Array.isArray(this._dirty.modules)) {
          this.set('_dirty.modules', []);
        }
        this.push('_dirty.modules', {intitule: 'Nouveau module', duree: 'P1D'});
      },

      _removeModule: function(evt) {
        var model = evt.model;
        this.splice('_dirty.modules', model.index);
      }

    });
  })();
  </script>
</dom-module>
