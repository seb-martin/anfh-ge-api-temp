<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="par-action-panel">
  <template>

    <style include="shared-styles"></style>

    <style>
    :host {
      display: block;
    }

    .back-zone {
      position: fixed;
      z-index: 4;
    }

    .commands-zone {
      margin: 5px;
      position:fixed;
      bottom: 60px;
      right: 60px;
      z-index: 4;
    }

    #backFab, #createFab, #updateFab {
      @apply(--shadow-elevation-6dp);
    }

    .content {
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    paper-card {
      width: 100%;
      margin: 20px 0;
    }

    paper-material {
      padding: 0 20px;
      margin: 10px 0;
    }

    #addModuleFab {
      margin-left: 5px;
    }


    </style>

    <div class="back-zone">
      <paper-fab id="backFab" icon="icons:arrow-back" on-tap="_backTap"></paper-fab>
      <paper-tooltip position="bottom">Retour à la liste des actions</paper-tooltip>
    </div>

    <div class="commands-zone">
      <template is="dom-if" if="{{!_dirty._id}}">
        <paper-fab id="createFab" icon="icons:add" on-tap="_createTap"></paper-fab>
        <paper-tooltip position="top">Ajouter cette action au plan</paper-tooltip>
      </template>
      <template is="dom-if" if="{{_dirty._id}}">
        <paper-fab id="updateFab" icon="icons:check" on-tap="_updateTap"></paper-fab>
        <paper-tooltip position="top">Mettre à jour cette action</paper-tooltip>
      </template>
    </div>

    <!-- Boite de dialogue de confirmation de suppression de module -->
    <paper-dialog id="confirmDeleteModule">
      <h2>Confirmation</h2>
      <p>
        Etes-vous sûr fr vouloir supprimer le module <em>{{_computeIntituleModule(_indexModuleToBeRemoved)}}</em>
        de l'action <em>{{_dirty.intitule}}</em> ?
      </p>
      <div class="buttons">
        <paper-button dialog-confirm autofocus on-tap="_confirmRemoveModuleTap">Oui</paper-button>
        <paper-button dialog-dismiss on-tap="_cancelRemoveModuleTap">Non</paper-button>
      </div>
    </paper-dialog>



    <div class="content">

      <form is="iron-form" id="actionForm">
        <paper-card heading="{{action.intitule}}">
          <div class="card-content layout vertical">

            <div class="layout horizontal">
              <span class="flex"></span>
              <paper-toggle-button checked="{{_dirty._publie}}" on-change="_publieChanged">Publiée</paper-toggle-button>
            </div>

            <paper-material elevation="1">
              <paper-input name="intitule" label="Intitulé" required char-counter maxlength="150" auto-validate value="{{_dirty.intitule}}"></paper-input>
            </paper-material>

            <paper-material elevation="1">
              <par-axe-select label="Axe" axes="[[axes]]" value="{{_dirty.axe}}"></par-axe-select>
            </paper-material>

            <paper-material elevation="1">
              <par-nature-select label="Nature" value="{{_dirty.nature}}" default="R" required auto-validate></par-nature-select>
            </paper-material>

            <paper-material elevation="1">
              <par-typologie-select label="Typologie" value="{{_dirty.typologie}}"></par-typologie-select>
            </paper-material>

            <paper-material elevation="1">
              <paper-input name="titulaire" label="Titulaire" char-counter maxlength="250" value="{{_dirty.titulaire}}"></paper-input>
            </paper-material>

            <paper-material elevation="1">
              <par-marked-textarea label="Contexte" value="{{_dirty.contexte}}" maxlength="1000"></par-marked-textarea>
            </paper-material>

            <paper-material elevation="1">
              <par-marked-textarea label="Objectifs" value="{{_dirty.objectifs}}" maxlength="600"></par-marked-textarea>
            </paper-material>

          </div>
        </paper-card>

        <paper-card heading="Publics">
          <div class="card-content">
            <par-public-list publics="{{_dirty.publics}}"></par-public-list>
          </div>
        </paper-card>

        <template is="dom-repeat" items="{{_dirty.modules}}" as="module">

          <paper-card heading="{{module.intitule}}">
            <div class="card-content layout vertical">

              <paper-material elevation="1">
                <paper-input name="intitule" label="Intitulé" required char-counter maxlength="150" auto-validate value="{{module.intitule}}"></paper-input>
              </paper-material>

              <paper-material elevation="1">
                <par-duree-input value="{{module.duree}}"></par-duree-input>
              </paper-material>

              <paper-material elevation="1">
                <paper-input label="Formateur" char-counter maxlength="250" value="{{module.formateur}}"></paper-input>
              </paper-material>

              <paper-material elevation="1">
                <par-marked-textarea label="Contexte" value="{{module.contexte}}" maxlength="1000"></par-marked-textarea>
              </paper-material>

              <paper-material elevation="1">
                <par-marked-textarea label="Objectifs" value="{{module.objectifs}}" maxlength="600"></par-marked-textarea>
              </paper-material>

              <paper-material elevation="1">
                <par-marked-textarea label="Programme" value="{{module.programme}}" maxlength="1700"></par-marked-textarea>
              </paper-material>

              <paper-card heading="Publics">
                <div class="card-content">
                  <par-public-list publics="{{module.publics}}"></par-public-list>
                </div>
              </paper-card>
            </div>
            <div class="card-actions layout horizontal">
              <span class="flex"></span>
              <paper-fab mini icon="icons:delete" on-tap="_removeModule"></paper-fab>
            </div>
          </paper-card>

        </template>

        <div class="layout horizontal center">
          <span class="flex"></span>
          <span>Ajouter un module &#8594;</span>
          <paper-fab id="addModuleFab" mini icon="icons:create" title="Ajouter un nouveau module" on-tap="_addModule"></paper-fab>
        </div>

        <paper-card heading="Calendrier">
          <div class="card-content">
            <par-evenement-list evenements="{{_dirty.calendrier}}"></par-evenement-list>
          </div>
        </paper-card>

      </form>

    </div>

    <paper-toast id="toast"></paper-toast>

  </template>


  <script>
  (function() {
    'use strict';

    var cloneAction = function(action) {
      if (!action) {
        return action;
      }

      var clone = {
        _id: action._id,
        _publie: action._publie,
        region: action.region,
        exercice: action.exercice,
        axe: action.axe,
        intitule: action.intitule,
        contexte: action.contexte,
        objectifs: action.objectifs,
        typologie: action.typologie,
        titulaire: action.titulaire,
        nature: action.nature,
        publics: [],
        modules: [],
        calendrier: []
      };

      if (Array.isArray(action.publics)) {
        action.publics.forEach(function(p) {
          clone.publics.push(p);
        });
      }

      if (Array.isArray(action.modules)) {
        action.modules.forEach(function(m) {
          var moduleClone = {
            intitule: m.intitule,
            contexte: m.contexte,
            objectifs: m.objectifs,
            programme: m.programme,
            duree: m.duree,
            formateur: m.formateur,
            publics: []
          };

          if (Array.isArray(m.publics)) {
            m.publics.forEach(function(p) {
              moduleClone.publics.push(p);
            });
          }

          clone.modules.push(moduleClone);
        });
      }

      if (Array.isArray(action.calendrier)) {
        clone.calendrier = action.calendrier.map(function(evenement) {
          return {
            debut: evenement.debut,
            fin: evenement.fin,
            ville: evenement.ville
          };
        });

      } else {
        clone.calendrier = action.calendrier;
      }

      return clone;
    };

    Polymer({
      is: 'par-action-panel',

      properties: {
        action: {
          type: Object,
          notify: true,
          observer: '_actionChanged'
        },

        axes: {
          type: Array,
          notify: true
        }
      },

      ready: function() {
      },

      _actionChanged: function(action) {
        this._dirty = cloneAction(action);
      },

      _backTap: function() {
        this._dirty = null;
        this.fire('back');
      },

      _cancelTap: function() {
        this._dirty = null;
        this.fire('cancel');
      },

      _createTap: function() {
        if (this.$.actionForm.validate()) {

          if (this._checkPublication()) {
            this.action = this._dirty;
            this.fire('create', {action: this.action});
          }

        } else {
          this.$.toast.text = 'Création l\'action refusée.';
          this.$.toast.text += ' Le formulaire comporte des données invalides';
          this.$.toast.open();
        }
      },

      _updateTap: function() {
        if (this.$.actionForm.validate()) {

          if (this._checkPublication()) {
            this.action = this._dirty;
            this.fire('update', {action: this.action});
          }

        } else {
          this.$.toast.text = 'Modification de l\'action refusée.';
          this.$.toast.text += ' Le formulaire comporte des données invalides';
          this.$.toast.open();
        }
      },

      _addModule: function() {
        if (!Array.isArray(this._dirty.modules)) {
          this.set('_dirty.modules', []);
        }
        this.push('_dirty.modules', {intitule: 'Nouveau module', duree: 'P1D'});
      },

      _removeModule: function(evt) {
        this._indexModuleToBeRemoved = evt.model.index;
        this.$.confirmDeleteModule.open();
      },

      _computeIntituleModule: function(idx) {
        return this._dirty.modules[idx].intitule;
      },

      _confirmRemoveModuleTap: function() {
        this.splice('_dirty.modules', this._indexModuleToBeRemoved, 1);
        delete this._indexModuleToBeRemoved;
        this.$.confirmDeleteModule.close();
      },

      _cancelRemoveModuleTap: function() {
        delete this._indexModuleToBeRemoved;
      },

      _publieChanged: function() {
        if (!this._checkPublication()) {
          this.set('_dirty._publie', false);
        }
      },

      _checkPublication: function() {
        var contexteEmpty =
          !this._dirty.contexte || !this._dirty.contexte.trim();
        var objectifsEmpty =
          !this._dirty.objectifs || !this._dirty.objectifs.trim();

        var check = !this._dirty._publie || !(contexteEmpty || objectifsEmpty);

        if (!check) {
          this.$.toast.text = [
            'Publication de l\'action refusée.',
            'L\'action requiert un contexte ET des objectifs',
            'pour être publiée.'
          ].join(' ');

          this.$.toast.open();
        }

        return check;
      }
    });
  })();
  </script>
</dom-module>
