<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="par-evenement-item">
  <template>

    <style include="shared-styles"></style>

    <style>
    :host {
      display: inline-block;
    }

    </style>

    <template is="dom-if" if="{{edition}}">
      <paper-icon-item id="editionItem">
        <iron-icon icon="icons:date-range" item-icon></iron-icon>

        <paper-item-body class="layout vertical">
          <div class="layout horizontal">
            <par-date-input label="Du" style="margin-right: 5px" value="{{_dirty.debut}}"></par-date-input>
            <par-date-input label="Au" style="margin-right: 5px" value="{{_dirty.fin}}"></par-date-input>
            <paper-input label="Ville" class="flex" value={{_dirty.ville}}>
              <!-- Hack pour que la hauteur du paper-input soit identique à celle des par-date-input -->
              <paper-icon-button suffix icon="icons:check-circle" style="visibility: hidden"></paper-icon-button>
            </paper-input>
          </div>
          <paper-input label="Détail" class="flex" value="{{_dirty.detail}}"></paper-input>
        </paper-item-body>
        <paper-icon-button icon="icons:check-circle" disabled="{{_computeUpdateDisabled(_dirty.debut, _dirty.fin)}}" on-tap="_updateTap"></paper-icon-button>
        <paper-icon-button icon="icons:cancel" on-tap="_cancelTap"></paper-icon-button>

      </paper-icon-item>
    </template>

    <template is="dom-if" if="{{!edition}}">
      <paper-icon-item id="consultationItem" active="{{edition}}" toggles>
        <iron-icon icon="icons:date-range" item-icon></iron-icon>

        <paper-item-body two-line>
          <template is="dom-if" if="{{_oneDay(value.debut, value.fin)}}">
            <div>
              Le
              <strong>{{_format(value.debut)}}</strong>
              ({{_fromNow(value.debut, value.fin)}})
              <span hidden$="{{!value.ville}}">, {{value.ville}}</span>
            </div>
          </template>
          <template is="dom-if" if="{{!_oneDay(value.debut, value.fin)}}">
            <div>
              Du
              <strong>{{_format(value.debut)}}</strong> au
              <strong>{{_format(value.fin)}}</strong>
              ({{_fromNow(value.debut, value.fin)}})
              <span hidden$="{{!value.ville}}">, {{value.ville}}</span>
            </div>
          </template>

          <div secondary>{{value.detail}}</div>
        </paper-item-body>
        <paper-icon-button icon="icons:remove-circle" on-tap="_removeTap"></paper-icon-button>

        <paper-ripple class="circle" recenters></paper-ripple>
      </paper-icon-item>
    </template>

  </template>

  <script>
  (function() {
    'use strict';

    var clone = function(evenement) {
      if (!evenement) {
        return evenement;
      }

      return {
        debut: evenement.debut,
        fin: evenement.fin,
        ville: evenement.ville,
        detail: evenement.detail
      };
    };

    Polymer({
      is: 'par-evenement-item',

      properties: {
        value: {
          type: Object,
          notify: true,
          value: function() {
            return {
              debut: moment().format('YYYY-MM-DD'),
              fin: moment().format('YYYY-MM-DD')
            };
          }
        },

        edition: {
          type: Boolean,
          notify: true,
          value: false,
          observer: '_editionChanged'
        },

        periode: {
          type: String,
          readOnly: true,
          notify: true,
          computed: '_computePeriode(value.debut, value.fin)'
        }
      },

      ready: function() {
      },

      _format: function(dateISO) {
        return moment(dateISO).format('D MMMM YYYY');
      },

      _fromNow: function(debutISO, finISO) {
        var now = moment();
        var debut = moment(debutISO);
        var fin = moment(finISO);

        var fromNow;
        if (now.isBefore(debut, 'day')) {
          fromNow = 'Démarre ' + debut.set('hour', 8).fromNow();
        } else if (now.isAfter(debut, 'day')) {
          fromNow = 'Terminé ' + fin.set('hour', 17).fromNow();
        } else {
          fromNow = 'En ce moment';
        }
        return fromNow;
      },

      _oneDay: function(debutISO, finISO) {
        return debutISO === finISO;
      },

      _computePeriode: function(debut, fin) {
        var format = 'D MMMM YYYY';

        return [
          'Du', moment(debut).format(format), 'au', moment(fin).format(format)
        ].join(' ');
      },

      _computeUpdateDisabled: function(debut, fin) {

        return moment(debut).isAfter(moment(fin));
      },

      _editionChanged: function(edition) {
        if (edition) {
          // En mode édition, on travaille sur une copie
          // afin de pouvoir annuler les modifications
          this._dirty = clone(this.value);
        } else {
          this._dirty = null;
        }

      },

      _updateTap: function() {
        this.fire('update-evenement', {evenement: this._dirty});
        this.edition = false;
      },

      _cancelTap: function() {
        this.fire('cancel-evenement');
        this.edition = false;
      },

      _removeTap: function() {
        this.fire('remove-evenement', {evenement: this.value});
      }

    });
  })();
  </script>
</dom-module>
