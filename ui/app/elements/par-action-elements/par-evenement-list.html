<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="par-evenement-list">
  <template>
    <style include="shared-styles"></style>

    <style>
      :host {
        @apply(--layout-vertical);
      }
      .list-item {
        border-bottom: 1px solid #dedede;
        background-color: #fff;

      }
    </style>

    <template is="dom-if" if="{{!evenements.length}}" >
      <paper-card elevation="1">
        <div class="card-content">

          <p>
            <em>La liste des évènements de cette planification est actuellement vide.</em>
          </p>
          <p>
            <em>

              Pour y ajouter un évènement,
              <ol>
                <li>
                  complétez les dates, ville et détail de l'évènement dans le formulaire de saisie ci-dessous ;
                </li>
                <li>
                  cliquez sur l'icône <iron-icon icon="icons:add-circle"></iron-icon>
                  située à droite du formulaire pour ajouter l'évènement à la liste.
                </li>
              </ol>
              <p>
                <em>
                  Attention, chaque planification doit comporter au moins un évènement
                  pour que l'action puisse être enregistrée.
                </em>
              </p>

            </em>
          </p>
        </div>
      </paper-card>
    </template>

    <paper-material elevation="1" class="list">
      <template is="dom-repeat" items="{{evenements}}" as="evenement">
        <par-evenement-item value="{{evenement}}" class="list-item" style="width: 100%"
          on-update-evenement="_updateEvenement"
          on-remove-evenement="_removeEvenement"
        ></par-evenement-item>
      </template>
    </paper-material>

    <paper-material elevation="0">
      <par-evenement-new-item mode="creation" style="width: 100%"
        value="{{_newEvenement}}"
        on-add-evenement="_addEvenement"
      ></par-evenement-new-item>
    </paper-material>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'par-evenement-list',

        behaviors: [
          Polymer.IronFormElementBehavior,
          Polymer.IronValidatableBehavior
        ],

        properties: {
          exercice: {
            type: Number,
            value: moment().year()
          },
          evenements: {
            type: Array,
            value: [],
            notify: true
          }
        },

        ready: function() {
          this._newEvenement = {
            debut: moment().year(this.exercice).format('YYYY-MM-DD'),
            fin: moment().year(this.exercice).format('YYYY-MM-DD')
          };
        },

        _findAddIndex: function(nouvelEvenement) {
          return this.evenements.reduceRight(
            function(addIndex, evenement, index) {
              var evtMoment = moment(evenement.debut);
              var newMoment = moment(nouvelEvenement.debut);
              if (evtMoment.isAfter(newMoment)) {
                return index;
              } else {
                return addIndex;
              }
            }, this.evenements.length
          );
        },

        _addEvenement: function(evt) {
          if (!Array.isArray(this.evenements)) {
            this.set('evenements', []);
          }

          var addIndex = this._findAddIndex(evt.detail.evenement);

          this.splice('evenements', addIndex, 0, evt.detail.evenement);

          this._newEvenement = {
            debut: moment().year(this.exercice).format('YYYY-MM-DD'),
            fin: moment().year(this.exercice).format('YYYY-MM-DD')
          };
        },

        _updateEvenement: function(evt) {
          // La date de début a pue changée
          // Il convient de replacer l'évènement dans la liste
          this.splice('evenements', evt.model.index, 1);
          var addIndex = this._findAddIndex(evt.detail.evenement);
          this.splice('evenements', addIndex, 0, evt.detail.evenement);
        },

        _removeEvenement: function(evt) {
          // Le removed est placé en new, pour être récupérable
          this._newEvenement = evt.detail.evenement;
          this.splice('evenements', evt.model.index, 1);
        }

      });

    })();
  </script>

</dom-module>
