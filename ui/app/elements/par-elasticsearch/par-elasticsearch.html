<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="par-elasticsearch">

  <script>

    (function() {
      'use strict';

      Polymer({
        is: 'par-elasticsearch',

        properties: {

          /**
           * Configuration du client elasticsearch.js.
           * cf. https://goo.gl/kJ1UQu
           */
          config: {
            type: Object,
            notify: true,
            observer: '_configChanged'
          },

          lastRequest: {
            type: Object,
            notify: true,
            readOnly: true
          },

          loading: {
            type: Boolean,
            notify: true,
            readOnly: true
          },

          lastResponse: {
            type: Object,
            notify: true,
            readOnly: true,
            observer: '_lastResponseChanged'
          },

          lastError: {
            type: Object,
            notify: true,
            readOnly: true
          }
        },

        observers: [
        ],

        created: function() {
        },

        _lastResponseChanged: function(/*lastResponse*/) {
          // console.log('_lastResponseChanged', lastResponse, this.status());
        },

        status: function() {
          return {
            config: this.config,
            lastRequest: this.lastRequest,
            loading: this.loading,
            lastResponse: this.lastResponse,
            lastError: this.lastError
          };
        },

        search: function(searchParams) {
          // console.log('search', searchParams);

          var promise;

          if (!this._client) {
            return;
          }

          promise = this._client.search(searchParams);

          this._followRequest(promise);

          return promise;
        },

        get: function(getParams) {
          var promise;

          if (!this._client) {
            return;
          }

          promise = this._client.get(getParams);

          this._followRequest(promise);

          return promise;
        },

        create: function(createParams) {
          var promise;

          if (!this._client) {
            return;
          }

          promise = this._client.create(createParams);

          this._followRequest(promise);

          return promise;
        },

        index: function(indexParams) {
          var promise;

          if (!this._client) {
            return;
          }

          promise = this._client.index(indexParams);

          this._followRequest(promise);

          return promise;
        },

        delete: function(deleteParams) {
          var promise;

          if (!this._client) {
            return;
          }

          promise = this._client.delete(deleteParams);

          this._followRequest(promise);

          return promise;
        },

        _configChanged: function(config) {
          this._setLoading(false);
          this._setLastRequest(null);
          this._setLastError(null);
          this._setLastResponse(null);
          
          if (config) {
            this._client = elasticsearch.Client(config);
          } else {
            this._client = null;
          }
        },

        _followRequest: function(promise) {
          console.log('_followRequest', promise);

          var self = this;

          self._setLoading(true);
          self._setLastRequest(promise);
          self.async(function() {
            self.fire('request', promise, {bubbles: false});
          });
          self._setLastError(null);
          self._setLastResponse(null);

          promise.then(function(response) {
            self._setLastResponse(response);
            self._setLoading(false);
            self.async(function() {
              self.fire('response', response, {bubbles: false});
            });
            console.log('_followRequest response', response);
          }).catch(function(error) {
            self._setLastError(error);
            self._setLoading(false);
            self.async(function() {
              self.fire('error', error, {bubbles: false});
            });
            console.log('_followRequest error', error);
          });

          return promise;
        }

      });
    })();

  </script>
</dom-module>

