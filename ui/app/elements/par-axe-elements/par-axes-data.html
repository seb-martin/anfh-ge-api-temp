<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="par-axes-data">

  <template>
    <par-globals id="globals"></par-globals>

    <iron-ajax
      id="axesData"
      auto
      method="POST"
      url="{{_searchUrl}}"
      contentType="application/json"
      body="{{_bodyString(codeRegion, exercice, from, size)}}"
      debounceDuration="300"
      handleAs="json"
      on-loading-changed="_handleLoading"
      on-response="_handleResponse"
      ></iron-ajax>

    <iron-ajax
      id="axesCreate"
      method="POST"
      url="{{_baseUrl}}",
      params="{{_computeCreateParams()}}"
      contentType="application/json"
      handleAs="json"
      on-loading-changed="_handleLoading"
      on-response="_handleCreateResponse"
      ></iron-ajax>

    <iron-ajax
      id="axesUpdate"
      method="PUT"
      params="{{_computeUpdateParams()}}"
      contentType="application/json"
      handleAs="json"
      on-loading-changed="_handleLoading"
      on-response="_handleUpdateResponse"
      ></iron-ajax>

    <iron-ajax
      id="axesDelete"
      method="DELETE"
      params="{{_computeDeleteParams()}}"
      contentType="application/json"
      handleAs="json"
      on-loading-changed="_handleLoading"
      on-response="_handleDeleteResponse"
      ></iron-ajax>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'par-axes-data',

        properties: {

          loading: {
            type: Boolean,
            reflectToAttribute: true,
            notify: true,
            readOnly: true
          },

          codeRegion: {
            type: Object
          },

          exercice: {
            type: Number
          },

          from: {
            type: Number,
            value: 0
          },

          size: {
            type: Number,
            value: 100
          },

          axes: {
            type: Array,
            notify: true,
            readOnly: true
          }
        },

        ready: function() {
          this._baseUrl = this.$.globals.esHost + '/par/axes';
          this._searchUrl = this._baseUrl + '/_search';
        },

        _bodyString: function(codeRegion, exercice, from, size) {
          var body = {
            from: from || 0,
            size: size || 100,
            sort: [
              {'region': {order: 'asc'}},
              {'exercice': {order: 'asc'}},
              {'num': {order: 'asc'}}
            ]
          };

          if (codeRegion || exercice) {
            body.query = {
              bool: {
                filter: []
              }
            };

            if (codeRegion) {
              body.query.bool.filter.push({term: {'region': codeRegion}});
            }

            if (exercice) {
              body.query.bool.filter.push({term: {'exercice': exercice}});
            }
          }

          return JSON.stringify(body);
        },

        _handleLoading: function(evt) {
          this._setLoading(evt.detail.value);
        },

        _handleResponse: function(evt) {
          if (!!evt.detail.response) {
            this._setAxes(this._mapSearchResp(evt.detail.response));
          } else {
            this._setAxes([]);
          }
        },

        refresh: function() {
          this.$.axesData.generateRequest();

        },

        _mapSearchResp: function(resp) {
          var self = this;

          if (!!resp) {
            return resp.hits.hits.map(function(resp) {
              return self._mapHit(resp);
            });
            
          } else {
            return [];
          }
        },

        _mapHit: function(hit) {
          // On ajoute à l'axe son id ES
          // - facilite la recherche
          // - différencie un nouvel axe
          hit._source._id = hit._id;
          return hit._source;
        },

        _computeCreateParams: function() {
          return {refresh: true};
        },

        creer: function(axe) {
          if (!axe) {
            throw 'L\'argument axe est requis';
          }

          this.$.axesCreate.body = JSON.stringify(axe);
          this.$.axesCreate.generateRequest();

        },

        _handleCreateResponse: function() {
          // Un axe a été créé, on rafraîchit la liste des axes
          this.refresh();
        },

        _computeUpdateParams: function() {
          return {refresh: true};
        },

        modifier: function(axe) {
          if (!axe) {
            throw 'L\'argument axe est requis';
          }

          // L'id est retiré du document avant sa mise à jour
          // L'id est conservé pour réaliser l'indexage du document
          var _id = axe._id;
          delete axe._id;

          this.$.axesUpdate.url = this._baseUrl + '/' + _id;
          this.$.axesUpdate.body = JSON.stringify(axe);
          this.$.axesUpdate.generateRequest();

        },

        _handleUpdateResponse: function() {
          // Un axe a été modifié, on rafraîchit la liste des axes
          this.refresh();
        },

        _computeDeleteParams: function() {
          return {refresh: true};
        },

        supprimer: function(axe) {
          if (!axe) {
            throw 'L\'argument axe est requis';
          }

          this.$.axesDelete.url = this._baseUrl + '/' + axe._id;
          this.$.axesDelete.generateRequest();

        },

        _handleDeleteResponse: function() {
          // Un axe a été supprimé, on rafraîchit la liste des axes
          this.refresh();
        }

      });

    })();
  </script>

</dom-module>